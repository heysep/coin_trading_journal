{% extends "base.html" %} {% block title %}대시보드 - ML 성능 모니터링{%
endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-tachometer-alt me-2"></i>ML 성능 모니터링 대시보드</h1>
  <div class="text-muted">
    <i class="fas fa-clock me-1"></i>
    마지막 업데이트:
    <span id="last-update">{{ data.last_update or '로딩 중...' }}</span>
  </div>
</div>

<!-- 1년치 백테스트 실행 패널 -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow">
      <div
        class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
      >
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-rocket me-2"></i>1년치 자동매매 백테스트 & ML 훈련
        </h6>
        <div class="dropdown no-arrow">
          <a
            class="dropdown-toggle"
            href="#"
            role="button"
            id="backtestDropdown"
            data-bs-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
          </a>
          <div
            class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
            aria-labelledby="backtestDropdown"
          >
            <div class="dropdown-header">백테스트 옵션:</div>
            <a class="dropdown-item" href="#" onclick="showBacktestSettings()"
              >고급 설정</a
            >
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" onclick="viewBacktestHistory()"
              >실행 기록</a
            >
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- 실행 컨트롤 -->
          <div class="col-md-4">
            <div class="form-group">
              <label for="symbol-select" class="form-label">거래 심볼</label>
              <select class="form-select" id="symbol-select">
                <option value="BTCUSDT" selected>BTC/USDT</option>
                <option value="ETHUSDT">ETH/USDT</option>
                <option value="BNBUSDT">BNB/USDT</option>
              </select>
            </div>
            <div class="form-group">
              <label for="chunk-size" class="form-label">청크 크기 (일)</label>
              <input
                type="number"
                class="form-control"
                id="chunk-size"
                value="30"
                min="7"
                max="90"
              />
              <small class="form-text text-muted"
                >작을수록 메모리 효율적, 클수록 빠름</small
              >
            </div>
            <div class="form-group mb-3">
              <label for="timeframe-select" class="form-label"
                >시간 프레임</label
              >
              <select class="form-select" id="timeframe-select">
                <option value="1m" selected>1분봉</option>
                <option value="5m">5분봉</option>
                <option value="1h">1시간봉</option>
              </select>
            </div>

            <!-- 실행 버튼들 -->
            <div class="d-grid gap-2">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                id="start-backtest-btn"
                onclick="startBacktest()"
              >
                <i class="fas fa-play me-2"></i>1년치 백테스트 시작
              </button>
              <button
                type="button"
                class="btn btn-warning"
                id="stop-backtest-btn"
                onclick="stopBacktest()"
                style="display: none"
              >
                <i class="fas fa-stop me-2"></i>중단
              </button>
            </div>
          </div>

          <!-- 진행 상황 -->
          <div class="col-md-8">
            <div id="backtest-status" style="display: none">
              <h6 class="text-primary mb-3">
                <i class="fas fa-chart-line me-2"></i>진행 상황
                <span class="badge bg-info ms-2" id="status-badge"
                  >준비 중</span
                >
              </h6>

              <!-- 진행률 표시 -->
              <div class="mb-3">
                <div
                  class="d-flex justify-content-between align-items-center mb-1"
                >
                  <span class="small text-muted">전체 진행률</span>
                  <span class="small text-muted" id="progress-percent">0%</span>
                </div>
                <div class="progress">
                  <div
                    class="progress-bar progress-bar-striped progress-bar-animated"
                    id="progress-bar"
                    role="progressbar"
                    style="width: 0%"
                    aria-valuenow="0"
                    aria-valuemin="0"
                    aria-valuemax="100"
                  ></div>
                </div>
              </div>

              <!-- 현재 단계 -->
              <div class="alert alert-info mb-3" id="current-step">
                <i class="fas fa-info-circle me-2"></i>
                <span id="step-text">준비 중...</span>
              </div>

              <!-- 실시간 로그 -->
              <div class="card">
                <div class="card-header py-2">
                  <h6 class="m-0 text-primary">
                    <i class="fas fa-terminal me-2"></i>실시간 로그
                    <button
                      class="btn btn-sm btn-outline-secondary float-end"
                      onclick="clearLogs()"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </h6>
                </div>
                <div class="card-body p-2">
                  <div
                    id="backtest-logs"
                    style="
                      height: 150px;
                      overflow-y: auto;
                      font-family: monospace;
                      font-size: 0.9rem;
                      background: #f8f9fa;
                      padding: 10px;
                      border-radius: 4px;
                    "
                  >
                    <!-- 로그 메시지들이 여기에 추가됩니다 -->
                  </div>
                </div>
              </div>
            </div>

            <!-- 결과 표시 -->
            <div id="backtest-result" style="display: none">
              <h6 class="text-success mb-3">
                <i class="fas fa-check-circle me-2"></i>백테스트 완료!
              </h6>
              <div class="row">
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-primary" id="result-trades">
                        -
                      </h5>
                      <p class="card-text small text-muted">생성된 거래</p>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-success" id="result-r2">-</h5>
                      <p class="card-text small text-muted">모델 R² 스코어</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-info" id="result-time">-</h5>
                      <p class="card-text small text-muted">실행 시간</p>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card bg-light">
                    <div class="card-body text-center">
                      <h5 class="card-title text-warning" id="result-winrate">
                        -
                      </h5>
                      <p class="card-text small text-muted">승률</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <button
                  class="btn btn-success me-2"
                  onclick="viewDetailedResults()"
                >
                  <i class="fas fa-chart-bar me-2"></i>상세 결과 보기
                </button>
                <button
                  class="btn btn-outline-primary"
                  onclick="downloadReport()"
                >
                  <i class="fas fa-download me-2"></i>리포트 다운로드
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 주요 지표 카드 -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-primary text-uppercase mb-1"
            >
              모델 건강성
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              <span id="health-score"
                >{{ data.health_check.score if data.health_check else 'N/A'
                }}</span
              >/100
            </div>
            <small class="text-muted">
              상태:
              <span
                id="health-status"
                class="status-{{ data.health_check.status if data.health_check else 'unknown' }}"
              >
                {{ data.health_check.status if data.health_check else 'Unknown'
                }}
              </span>
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-heartbeat fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-success text-uppercase mb-1"
            >
              최신 R² 점수
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {% if data.health_check and data.health_check.latest_performance
              %} {{ "%.4f"|format(data.health_check.latest_performance.r2_score)
              }} {% else %} N/A {% endif %}
            </div>
            <small class="text-muted">
              {% if data.performance_summary and
              data.performance_summary.trend_analysis %} {{
              data.performance_summary.trend_analysis.r2_trend }} {% endif %}
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
              총 평가 횟수
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ data.total_evaluations or 0 }}
            </div>
            <small class="text-muted">
              최근 7일: {% if data.performance_summary and
              data.performance_summary.total_evaluations %} {{
              data.performance_summary.total_evaluations }}건 {% else %} 0건 {%
              endif %}
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card metric-card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div
              class="text-xs font-weight-bold text-warning text-uppercase mb-1"
            >
              총 알림
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ data.total_alerts or 0 }}
            </div>
            <small class="text-muted">
              심각: {% if data.performance_summary and
              data.performance_summary.alerts_summary %} {{
              data.performance_summary.alerts_summary.critical_alerts }}건 {%
              else %} 0건 {% endif %}
            </small>
          </div>
          <div class="col-auto">
            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 성능 차트 및 최근 알림 -->
<div class="row">
  <!-- 성능 트렌드 차트 -->
  <div class="col-xl-8 col-lg-7">
    <div class="card shadow mb-4">
      <div
        class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
      >
        <h6 class="m-0 font-weight-bold text-primary">성능 트렌드</h6>
        <div class="dropdown no-arrow">
          <select
            id="chart-period"
            class="form-select form-select-sm"
            onchange="updateChart()"
          >
            <option value="7">최근 7일</option>
            <option value="30" selected>최근 30일</option>
            <option value="90">최근 90일</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <div class="chart-area">
          <canvas id="performanceChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 최근 알림 -->
  <div class="col-xl-4 col-lg-5">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">최근 알림</h6>
      </div>
      <div class="card-body">
        {% if data.recent_alerts %}
        <div class="list-group list-group-flush">
          {% for alert in data.recent_alerts[-5:] %}
          <div class="list-group-item alert-{{ alert.severity }} px-0">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">
                {% if alert.severity == 'critical' %}
                <i class="fas fa-times-circle text-danger"></i>
                {% elif alert.severity == 'high' %}
                <i class="fas fa-exclamation-circle text-warning"></i>
                {% elif alert.severity == 'medium' %}
                <i class="fas fa-info-circle text-info"></i>
                {% else %}
                <i class="fas fa-check-circle text-success"></i>
                {% endif %} {{ alert.alert_type|title }}
              </h6>
              <small>{{ alert.timestamp[:16] }}</small>
            </div>
            <p class="mb-1">{{ alert.message }}</p>
            <small class="text-muted">{{ alert.recommendation }}</small>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
          <i class="fas fa-bell-slash fa-2x mb-3"></i>
          <p>최근 알림이 없습니다</p>
        </div>
        {% endif %}

        <div class="mt-3">
          <a
            href="{{ url_for('alerts') }}"
            class="btn btn-primary btn-sm w-100"
          >
            <i class="fas fa-eye me-1"></i>모든 알림 보기
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 성능 요약 정보 -->
{% if data.performance_summary and data.performance_summary.performance_metrics
%}
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">최근 7일 성능 요약</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-primary">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.avg_r2)
                }}
              </div>
              <div class="text-muted">평균 R²</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-success">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.avg_rmse)
                }}
              </div>
              <div class="text-muted">평균 RMSE</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-info">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.max_r2)
                }}
              </div>
              <div class="text-muted">최대 R²</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 text-warning">
                {{
                "%.4f"|format(data.performance_summary.performance_metrics.min_rmse)
                }}
              </div>
              <div class="text-muted">최소 RMSE</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- 추천사항 -->
{% if data.performance_summary and data.performance_summary.recommendations %}
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-lightbulb me-1"></i>추천사항
        </h6>
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0">
          {% for recommendation in data.performance_summary.recommendations %}
          <li class="mb-2">
            <i class="fas fa-arrow-right text-primary me-2"></i>
            {{ recommendation }}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  // 성능 차트 설정
  let performanceChart;
  let pnlChart;

  function initChart() {
    const ctx = document.getElementById("performanceChart").getContext("2d");

    // 초기 빈 차트
    performanceChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "R² Score",
            data: [],
            borderColor: "rgb(75, 192, 192)",
            backgroundColor: "rgba(75, 192, 192, 0.1)",
            tension: 0.1,
            yAxisID: "y",
          },
          {
            label: "RMSE",
            data: [],
            borderColor: "rgb(255, 99, 132)",
            backgroundColor: "rgba(255, 99, 132, 0.1)",
            tension: 0.1,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: "index",
          intersect: false,
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: "시간",
            },
          },
          y: {
            type: "linear",
            display: true,
            position: "left",
            title: {
              display: true,
              text: "R² Score",
            },
            min: 0,
            max: 1,
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            title: {
              display: true,
              text: "RMSE",
            },
            grid: {
              drawOnChartArea: false,
            },
          },
        },
        plugins: {
          title: {
            display: true,
            text: "모델 성능 트렌드",
          },
          legend: {
            display: true,
            position: "top",
          },
        },
      },
    });

    // 초기 데이터 로드
    updateChart();
  }

  // 손익 차트 초기화
  function initPnlChart() {
    const ctx = document.getElementById("pnlChart").getContext("2d");
    pnlChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "PnL ($)",
            data: [],
            borderColor: "rgb(99, 132, 255)",
            backgroundColor: "rgba(99, 132, 255, 0.1)",
            tension: 0.1,
            yAxisID: "y",
          },
          {
            label: "누적 PnL ($)",
            data: [],
            borderColor: "rgb(54, 162, 235)",
            backgroundColor: "rgba(54, 162, 235, 0.1)",
            tension: 0.1,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { autoSkip: true, maxTicksLimit: 10 },
            grid: { display: false },
          },
          y: {
            position: "left",
            title: { display: true, text: "PnL ($)" },
            ticks: { maxTicksLimit: 6 },
          },
          y1: {
            position: "right",
            title: { display: true, text: "누적 PnL ($)" },
            grid: { drawOnChartArea: false },
            ticks: { maxTicksLimit: 6 },
          },
        },
        plugins: {
          legend: { position: "top" },
          title: { display: true, text: "최근 백테스트 손익 추이" },
          decimation: { enabled: true, algorithm: "min-max" },
        },
      },
    });
    updatePnlChart();
  }

  function updatePnlChart() {
    const agg = document.getElementById("aggToggle")?.checked ? "daily" : "raw";
    const days = document.getElementById("pnl-period")?.value || 30;
    // 한글 주석: 캐시 무효화를 위해 타임스탬프 쿼리 추가 및 no-store 옵션 사용
    // 한글 주석: 카드 타이틀이 '최근 백테스트'이므로 기본 요청은 CSV 최신 기준으로 강제
    // 한글 주석: 모든 기간에서 CSV 병합 데이터 사용
    const mode = "all";
    fetch(
      `/api/pnl_history?agg=${agg}&days=${days}&source=csv&mode=${mode}&_ts=${Date.now()}`,
      {
        cache: "no-store",
      }
    )
      .then((res) => {
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        return res.json();
      })
      .then((data) => {
        if (!data.success) {
          console.error("API 응답 오류:", data.error);
          return;
        }
        const c = data.chart_data;

        // 한글 주석: 데이터가 없는 경우 처리
        if (!c.timestamps || c.timestamps.length === 0) {
          console.log("PnL 데이터가 없습니다");
          // 빈 차트 표시
          pnlChart.data.labels = [];
          pnlChart.data.datasets[0].data = [];
          pnlChart.data.datasets[1].data = [];
          pnlChart.update();
          return;
        }

        const labels = c.timestamps.map((ts) =>
          new Date(ts).toLocaleString("ko-KR")
        );
        pnlChart.data.labels = labels;
        pnlChart.data.datasets[0].data = c.pnl;
        pnlChart.data.datasets[1].data = c.cum_pnl;

        // 한글 주석: 데이터 포인트가 2개 미만이면 점을 크게 보여 가시성 확보
        const isSparse = labels.length < 2;
        pnlChart.data.datasets.forEach((ds) => {
          ds.pointRadius = isSparse ? 5 : 3;
          ds.pointHoverRadius = isSparse ? 7 : 4;
          ds.showLine = !isSparse; // 점만 표시
        });
        pnlChart.update();

        const src = document.getElementById("pnl-source");
        if (src)
          src.textContent = c.source_file ? `파일: ${c.source_file}` : "";

        // 지표 업데이트
        const m = data.metrics || {};
        document.getElementById("m-trades").textContent = m.trades ?? "-";
        document.getElementById("m-total").textContent = (
          m.total_pnl ?? 0
        ).toLocaleString("en-US");
        document.getElementById("m-win").textContent = m.win_rate
          ? `${m.win_rate}%`
          : "-";
        document.getElementById("m-avg").textContent = (m.avg_pnl ?? 0).toFixed(
          2
        );
        document.getElementById("m-mdd").textContent = m.max_drawdown_pct
          ? `${m.max_drawdown_pct}%`
          : "-";
        document.getElementById("m-cagr-sharpe").textContent =
          `${m.cagr_pct ?? 0}% / ${m.sharpe ?? 0}`;

        console.log(
          `PnL 차트 업데이트 완료: ${c.timestamps.length}개 데이터포인트`
        );
      })
      .catch((err) => {
        console.error("PnL 차트 갱신 실패:", err);
        // 에러 표시를 위한 UI 업데이트도 가능
      });
  }

  // 학습 개선점 차트 초기화
  function initLearningChart() {
    const ctx = document.getElementById("learningChart").getContext("2d");
    window.learningChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "R² Score",
            data: [],
            borderColor: "rgba(75, 192, 192, 1)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            tension: 0.1,
          },
          {
            label: "승률 (%)",
            data: [],
            borderColor: "rgba(255, 99, 132, 1)",
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            tension: 0.1,
            yAxisID: "y1",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: "학습 사이클" } },
          y: {
            title: { display: true, text: "R² Score" },
            min: 0.99,
            max: 1.0,
          },
          y1: {
            type: "linear",
            display: true,
            position: "right",
            title: { display: true, text: "승률 (%)" },
            grid: { drawOnChartArea: false },
          },
        },
        plugins: {
          title: { display: true, text: "학습 사이클별 성능 개선" },
        },
      },
    });
  }

  // 피처 중요도 차트 초기화
  function initFeatureChart() {
    const ctx = document.getElementById("featureChart").getContext("2d");
    window.featureChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "PnL Ratio",
            data: [],
            borderColor: "rgba(255, 206, 86, 1)",
            backgroundColor: "rgba(255, 206, 86, 0.2)",
            tension: 0.1,
          },
          {
            label: "Market Condition",
            data: [],
            borderColor: "rgba(54, 162, 235, 1)",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            tension: 0.1,
          },
          {
            label: "Volatility",
            data: [],
            borderColor: "rgba(153, 102, 255, 1)",
            backgroundColor: "rgba(153, 102, 255, 0.2)",
            tension: 0.1,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: "학습 사이클" } },
          y: {
            title: { display: true, text: "피처 중요도" },
            min: 0,
            max: 0.5,
          },
        },
        plugins: {
          title: { display: true, text: "주요 피처 중요도 변화" },
        },
      },
    });
  }

  // 학습 개선점 데이터 업데이트
  function updateLearningChart() {
    fetch("/api/learning_improvements")
      .then((res) => res.json())
      .then((data) => {
        if (Array.isArray(data) && data.length > 0) {
          const labels = data.map((cycle) => `사이클 ${cycle.cycle}`);
          const r2_scores = data.map(
            (cycle) => cycle.model_metrics?.test_r2 || 0
          );
          const win_rates = data.map(
            (cycle) => cycle.backtest_summary?.win_rate || 0
          );

          learningChart.data.labels = labels;
          learningChart.data.datasets[0].data = r2_scores;
          learningChart.data.datasets[1].data = win_rates;
          learningChart.update();
        }
      })
      .catch((err) => console.error("학습 차트 갱신 실패:", err));
  }

  // 피처 중요도 데이터 업데이트
  function updateFeatureChart() {
    fetch("/api/feature_importance_trend")
      .then((res) => res.json())
      .then((data) => {
        if (Array.isArray(data) && data.length > 0) {
          const labels = data.map((cycle) => `사이클 ${cycle.cycle}`);
          const pnl_ratios = data.map((cycle) => cycle.pnl_ratio || 0);
          const market_conditions = data.map(
            (cycle) => cycle.market_condition || 0
          );
          const volatilities = data.map((cycle) => cycle.volatility || 0);

          featureChart.data.labels = labels;
          featureChart.data.datasets[0].data = pnl_ratios;
          featureChart.data.datasets[1].data = market_conditions;
          featureChart.data.datasets[2].data = volatilities;
          featureChart.update();
        }
      })
      .catch((err) => console.error("피처 차트 갱신 실패:", err));
  }

  function updateChart() {
    const period = document.getElementById("chart-period").value;

    fetch(`/api/performance_history?days=${period}`)
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const chartData = data.chart_data;

          // 타임스탬프를 읽기 쉬운 형태로 변환
          const labels = chartData.timestamps.map((ts) => {
            const date = new Date(ts);
            return (
              date.toLocaleDateString("ko-KR") +
              " " +
              date.toLocaleTimeString("ko-KR", {
                hour: "2-digit",
                minute: "2-digit",
              })
            );
          });

          performanceChart.data.labels = labels;
          performanceChart.data.datasets[0].data = chartData.r2_scores;
          performanceChart.data.datasets[1].data = chartData.rmse_scores;

          performanceChart.update();
        }
      })
      .catch((error) => {
        console.error("차트 데이터 로드 실패:", error);
      });
  }

  // 페이지 로드 시 차트 초기화
  document.addEventListener("DOMContentLoaded", function () {
    initChart();
    initPnlChart();
    initLearningChart();
    initFeatureChart();

    // 학습 개선점 차트 업데이트
    updateLearningChart();
    updateFeatureChart();

    // 한글 주석: PnL 차트 자동 갱신 (60초마다)
    setInterval(() => {
      try {
        updatePnlChart();
      } catch (e) {
        console.error("자동 갱신 실패:", e);
      }
    }, 60000);
  });

  // ================================
  // 1년치 백테스트 실행 기능
  // ================================

  let backtestStatusInterval = null;

  // 백테스트 시작
  function startBacktest() {
    const symbol = document.getElementById("symbol-select").value;
    const chunkSize = parseInt(document.getElementById("chunk-size").value);
    const timeframe = document.getElementById("timeframe-select").value;

    // 입력값 검증
    if (chunkSize < 7 || chunkSize > 90) {
      alert("청크 크기는 7-90일 사이로 설정해주세요.");
      return;
    }

    // UI 상태 변경
    document.getElementById("start-backtest-btn").style.display = "none";
    document.getElementById("stop-backtest-btn").style.display = "block";
    document.getElementById("backtest-status").style.display = "block";
    document.getElementById("backtest-result").style.display = "none";

    // 로그 초기화
    clearLogs();
    addLog(
      `${symbol} 1년치 백테스트 시작 (청크: ${chunkSize}일, 시간프레임: ${timeframe})`
    );

    // 백테스트 시작 API 호출
    fetch("/api/backtest/start", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        symbol: symbol,
        chunk_size: chunkSize,
        timeframe: timeframe,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          addLog(`✅ ${data.message}`);
          // 진행상황 모니터링 시작
          backtestStatusInterval = setInterval(checkBacktestStatus, 2000);
        } else {
          addLog(`❌ 시작 실패: ${data.error}`);
          resetBacktestUI();
        }
      })
      .catch((error) => {
        console.error("백테스트 시작 오류:", error);
        addLog(`❌ 네트워크 오류: ${error.message}`);
        resetBacktestUI();
      });
  }

  // 백테스트 중단
  function stopBacktest() {
    if (confirm("정말로 백테스트를 중단하시겠습니까?")) {
      fetch("/api/backtest/stop", {
        method: "POST",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            addLog(`⏹️ ${data.message}`);
          } else {
            addLog(`❌ 중단 실패: ${data.error}`);
          }
        })
        .catch((error) => {
          console.error("백테스트 중단 오류:", error);
          addLog(`❌ 중단 요청 실패: ${error.message}`);
        });
    }
  }

  // 백테스트 상태 확인
  function checkBacktestStatus() {
    fetch("/api/backtest/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.status) {
          updateBacktestUI(data.status);

          // 완료되거나 오류 발생시 모니터링 중단
          if (!data.status.running) {
            clearInterval(backtestStatusInterval);
            backtestStatusInterval = null;

            if (data.status.result) {
              showBacktestResult(data.status.result);
            } else if (data.status.error) {
              addLog(`❌ 오류 발생: ${data.status.error}`);
              resetBacktestUI();
            }
          }
        }
      })
      .catch((error) => {
        console.error("상태 확인 오류:", error);
      });
  }

  // 백테스트 UI 업데이트
  function updateBacktestUI(status) {
    // 진행률 업데이트
    const progress = status.progress || 0;
    document.getElementById("progress-bar").style.width = progress + "%";
    document
      .getElementById("progress-bar")
      .setAttribute("aria-valuenow", progress);
    document.getElementById("progress-percent").textContent = progress + "%";

    // 현재 단계 업데이트
    document.getElementById("step-text").textContent =
      status.current_step || "진행 중...";

    // 상태 배지 업데이트
    const statusBadge = document.getElementById("status-badge");
    if (status.running) {
      statusBadge.textContent = "실행 중";
      statusBadge.className = "badge bg-primary ms-2";
    } else if (status.error) {
      statusBadge.textContent = "오류";
      statusBadge.className = "badge bg-danger ms-2";
    } else {
      statusBadge.textContent = "완료";
      statusBadge.className = "badge bg-success ms-2";
    }

    // 새로운 로그 추가
    if (status.logs && status.logs.length > 0) {
      const currentLogCount =
        document.getElementById("backtest-logs").children.length;
      const newLogs = status.logs.slice(currentLogCount);

      newLogs.forEach((log) => {
        addLogDirect(log);
      });
    }
  }

  // 백테스트 결과 표시
  function showBacktestResult(result) {
    document.getElementById("backtest-status").style.display = "none";
    document.getElementById("backtest-result").style.display = "block";

    // 결과 데이터 표시
    document.getElementById("result-trades").textContent =
      (result.trades_generated || 0).toLocaleString() + "건";
    document.getElementById("result-r2").textContent = (
      result.model_r2 || 0
    ).toFixed(3);
    document.getElementById("result-time").textContent =
      (result.execution_time_hours || 0).toFixed(1) + "시간";
    document.getElementById("result-winrate").textContent =
      (result.win_rate || 0).toFixed(1) + "%";

    addLog(
      `🎉 백테스트 완료! 거래 ${result.trades_generated || 0}건 생성, 모델 R² ${(result.model_r2 || 0).toFixed(3)}`
    );

    resetBacktestUI();
  }

  // UI 리셋
  function resetBacktestUI() {
    document.getElementById("start-backtest-btn").style.display = "block";
    document.getElementById("stop-backtest-btn").style.display = "none";

    if (backtestStatusInterval) {
      clearInterval(backtestStatusInterval);
      backtestStatusInterval = null;
    }
  }

  // 로그 추가 (시간 포함)
  function addLog(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = `${timestamp} - ${message}`;
    addLogDirect(logMessage);
  }

  // 로그 직접 추가
  function addLogDirect(logMessage) {
    const logsContainer = document.getElementById("backtest-logs");
    const logElement = document.createElement("div");
    logElement.textContent = logMessage;
    logElement.style.marginBottom = "2px";
    logsContainer.appendChild(logElement);

    // 자동 스크롤
    logsContainer.scrollTop = logsContainer.scrollHeight;

    // 로그 개수 제한 (최대 100개)
    while (logsContainer.children.length > 100) {
      logsContainer.removeChild(logsContainer.firstChild);
    }
  }

  // 로그 초기화
  function clearLogs() {
    document.getElementById("backtest-logs").innerHTML = "";
  }

  // 고급 설정 표시
  function showBacktestSettings() {
    alert(
      "고급 설정 기능은 추후 구현 예정입니다.\n현재는 기본 설정만 지원합니다."
    );
  }

  // 백테스트 기록 보기
  function viewBacktestHistory() {
    alert("백테스트 실행 기록 기능은 추후 구현 예정입니다.");
  }

  // 상세 결과 보기
  function viewDetailedResults() {
    // 상세 결과 페이지로 이동
    window.open("/detailed-results", "_blank");
  }

  // 리포트 다운로드
  function downloadReport() {
    // 리포트 다운로드 API 호출 (구현 필요)
    alert("리포트 다운로드 기능은 추후 구현 예정입니다.");
  }
</script>
{% endblock %}
