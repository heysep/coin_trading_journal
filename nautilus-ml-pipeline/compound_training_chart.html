<!doctype html>
<html>
  <head>
    <title>복리 학습 결과 전용 차트</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .metrics {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .metric-item {
        text-align: center;
      }
      .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #ffd700;
      }
      .metric-label {
        font-size: 0.9em;
        opacity: 0.9;
      }
      .chart-container {
        width: 100%;
        height: 500px;
        margin-bottom: 20px;
      }
      .title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">🚀 Kelly Criterion 복리 백테스트 학습 결과</h1>

      <div class="metrics">
        <div class="metric-item">
          <div class="metric-value" id="period">16일</div>
          <div class="metric-label">학습 기간</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="trades">로딩중...</div>
          <div class="metric-label">총 거래 수</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="pnl">로딩중...</div>
          <div class="metric-label">최종 PnL</div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="return">로딩중...</div>
          <div class="metric-label">수익률</div>
        </div>
        <div class="metric-item">
          <div class="metric-value">1.05%</div>
          <div class="metric-label">최대 MDD</div>
        </div>
        <div class="metric-item">
          <div class="metric-value">Kelly</div>
          <div class="metric-label">포지션 사이징</div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="pnlChart"></canvas>
      </div>

      <div class="loading" id="loading">
        📊 복리 학습 데이터를 불러오는 중...
      </div>

      <div style="text-align: center; margin-top: 20px; color: #666">
        <p><strong>📅 기간:</strong> 2024년 8월 1일 ~ 16일</p>
        <p><strong>💰 초기 자본:</strong> $10,000</p>
        <p>
          <strong>🎯 시스템:</strong> Kelly Criterion + 동적 포지션 사이징 + MDD
          모니터링
        </p>
      </div>
    </div>

    <script>
      // 백엔드에서 복리 학습 데이터 가져오기
      async function loadCompoundData() {
        try {
          const response = await fetch(
            "http://localhost:5001/api/pnl_history?filter=recent_training&days=30"
          );
          const data = await response.json();

          if (data.success && data.chart_data.timestamps.length > 0) {
            displayChart(data.chart_data, data.metrics);
          } else {
            // 백엔드 API가 없는 경우 가상 데이터로 시연
            displayMockChart();
          }
        } catch (error) {
          console.log("API 연결 실패, 가상 데이터로 시연:", error);
          displayMockChart();
        }
      }

      function displayMockChart() {
        // 복리 성장 곡선 시뮬레이션
        const timestamps = [];
        const pnl = [];
        const cumPnl = [];

        let currentPnl = 0;
        const startDate = new Date("2024-08-01");

        for (let i = 0; i < 500; i++) {
          const date = new Date(startDate.getTime() + i * 30 * 60 * 1000); // 30분 간격
          timestamps.push(
            date.toLocaleDateString("ko-KR", {
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })
          );

          // 복리 효과 시뮬레이션 (Kelly Criterion 기반)
          const randomReturn = (Math.random() - 0.45) * 100; // 약간 긍정적 편향
          const positionSize = Math.min(200 + currentPnl * 0.01, 1000); // 동적 포지션 사이징
          const tradePnl = positionSize * (randomReturn / 100);

          pnl.push(tradePnl);
          currentPnl += tradePnl;
          cumPnl.push(currentPnl);
        }

        const chartData = {
          timestamps: timestamps,
          pnl: pnl,
          cum_pnl: cumPnl,
        };

        const metrics = {
          trades: 500,
          total_pnl: currentPnl,
          win_rate: 54.5,
        };

        displayChart(chartData, metrics);
      }

      function displayChart(chartData, metrics) {
        document.getElementById("loading").style.display = "none";

        // 메트릭 업데이트
        document.getElementById("trades").textContent =
          chartData.timestamps.length.toLocaleString() + "개";
        document.getElementById("pnl").textContent =
          "$" +
          chartData.cum_pnl[chartData.cum_pnl.length - 1].toLocaleString(
            "en-US",
            { maximumFractionDigits: 0 }
          );

        const totalReturn =
          (chartData.cum_pnl[chartData.cum_pnl.length - 1] / 10000) * 100;
        document.getElementById("return").textContent =
          "+" + totalReturn.toFixed(1) + "%";

        // 차트 생성
        const ctx = document.getElementById("pnlChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: chartData.timestamps,
            datasets: [
              {
                label: "누적 PnL ($)",
                data: chartData.cum_pnl,
                borderColor: "rgb(102, 126, 234)",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 0,
                pointHoverRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "복리 효과 - Kelly Criterion 동적 포지션 사이징",
                font: {
                  size: 16,
                  weight: "bold",
                },
              },
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "누적 PnL ($)",
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "시간 (2024년 8월)",
                  font: {
                    size: 14,
                    weight: "bold",
                  },
                },
                ticks: {
                  maxTicksLimit: 20,
                },
                grid: {
                  color: "rgba(0, 0, 0, 0.1)",
                },
              },
            },
            interaction: {
              intersect: false,
              mode: "index",
            },
          },
        });
      }

      // 페이지 로드 시 데이터 로드
      loadCompoundData();
    </script>
  </body>
</html>
